# Fi-Red-Sim 実装計画

## 1. 実装フェーズ

### フェーズ1: 基本シミュレーション機能の実装
**目標**: 単一のセンサーデバイスのシミュレーションと可視化の実現

1. 開発環境の構築
   - [x] Node-RED Dockerコンテナの設定
   - [x] 必要なNode-REDノードのインストール設定
   - [x] 開発用ダッシュボードの初期設定

2. 基本シミュレーション機能の実装
   - [x] 温度センサーシミュレーションフローの作成
     - [x] 基本的なセンサー値生成ロジック
     - [x] パラメータ設定機能
     - [x] データ出力インターフェース
   - [x] シミュレーション制御機能
     - [x] 開始/停止制御
     - [x] パラメータ調整機能
     - [x] 基本的なエラーハンドリング

3. 基本可視化機能の実装
   - [x] リアルタイムデータ表示
     - [x] 現在値の数値表示
     - [x] 時系列グラフ表示
   - [x] 基本的な制御UI
     - [x] シミュレーション開始/停止ボタン
     - [x] パラメータ設定フォーム

4. 異常値生成機能の実装
   - [x] 基本的な異常パターン
     - [x] スパイク
     - [x] センサー故障
     - [x] 通信エラー
   - [x] 高度な異常パターン
     - [x] トレンド変化
     - [x] 周期的な異常
     - [x] ノイズ増加
   - [x] 異常値設定UI
     - [x] 異常タイプ選択
     - [x] パラメータ調整
     - [x] 状態表示

### フェーズ2: 温度センサーのマルチインスタンス対応
**目標**: 温度センサーの基本的な複数インスタンス管理の実現

1. マルチインスタンス基本機能
   - [ ] 温度センサーインスタンス管理
     - [ ] 動的な温度センサー生成
     - [ ] 基本設定機能
     - [ ] 一括開始/停止制御
   - [ ] 基本的なUI
     - [ ] 温度センサー一覧表示
     - [ ] センサー追加/削除機能
     - [ ] 基本パラメータ設定
   - [ ] データ管理
     - [ ] センサーごとのデータ分離
     - [ ] 基本的な統計（平均値）

2. シンプルな可視化機能
   - [ ] マルチビュー
     - [ ] リスト表示
     - [ ] 基本グラフ表示
   - [ ] 監視機能
     - [ ] 基本的なアラート
     - [ ] 動作状態表示

### フェーズ3: FIWARE基本連携
**目標**: FIWAREとの最小限の連携実現

1. FIWARE連携基盤
   - [ ] 基本的なNGSIv2データモデル
   - [ ] Context Broker基本連携
   - [ ] 基本的なエラーハンドリング

2. 動作検証
   - [ ] 基本的な結合テスト
   - [ ] 簡易的なログ収集

## 2. ディレクトリ構成

```
fi-red-sim/
├── docker/                     # Docker関連ファイル
│   ├── node-red/              # Node-RED用Dockerfile等
│   └── fiware/                # FIWARE用Dockerfile等（オプション）
│
├── flows/                     # Node-REDフロー定義
│   ├── simulations/          # シミュレーションフロー
│   │   ├── sensors/         # センサーデバイス用フロー
│   │   └── actuators/       # アクチュエータ用フロー
│   ├── visualizations/       # 可視化用フロー
│   └── integrations/         # 外部連携用フロー
│
├── config/                    # 設定ファイル
│   ├── node-red/             # Node-RED設定
│   └── devices/              # デバイス定義
│
├── docs/                      # ドキュメント
│   ├── planning/             # 計画ドキュメント
│   ├── api/                  # API仕様
│   └── usage/                # 使用方法
│
├── tests/                     # テストファイル
│   ├── flows/                # フローテスト
│   ├── integration/          # 統合テスト
│   └── performance/          # 性能テスト
│
└── scripts/                   # ユーティリティスクリプト
    ├── setup/                # セットアップスクリプト
    └── maintenance/          # メンテナンス用スクリプト
```

## 3. 開発ガイドライン

### フロー開発ルール
1. 各フローは単一の責務を持つ
2. フロー間の依存関係を明確にする
3. エラーハンドリングを必ず実装
4. デバッグノードを適切に配置

### コンポーネント分割の方針
1. シミュレーションロジック
   - デバイスタイプごとに分離
   - パラメータ設定を外部化
   - 再利用可能なサブフロー化

2. 可視化コンポーネント
   - 機能ごとにタブ分割
   - 共通UIコンポーネントの標準化
   - レスポンシブデザインの考慮

### 命名規則
1. フロー
   - デバイスシミュレーション: `sim-{deviceType}-{function}`
   - 可視化: `viz-{deviceType}-{component}`
   - 統合: `int-{system}-{function}`

2. ノード
   - 入力: `input-{purpose}`
   - 処理: `proc-{function}`
   - 出力: `output-{destination}`

## 4. 実装の優先順位

1. 最初のイテレーション（2週間）
   - 基本的な温度センサーシミュレーション
   - シンプルなダッシュボード表示
   - 開始/停止制御
   ※ 完了済み

2. 第2イテレーション（2週間）
   - パラメータ調整機能
   - グラフ表示の改善
   - エラーハンドリング
   ※ 完了済み

3. 第3イテレーション（1週間）
   - FIWARE基本連携
     - NGSIv2基本データモデル実装
       - 温度センサーエンティティの定義
       - 属性の設定
     - Context Broker基本連携
       - エンティティの作成/更新
       - 測定値の送信
     - 基本的なエラーハンドリング

4. 第4イテレーション（1週間）
   - マルチインスタンス基本機能
     - 温度センサーの動的生成機能
     - センサー追加/削除UI
     - FIWARE連携を考慮したパラメータ設定

5. 第5イテレーション（1週間）
   - 基本的な可視化機能
     - センサー一覧表示
     - マルチセンサーグラフ
     - 基本的なアラート

各イテレーションの終了時にレビューを行い、必要に応じて計画を調整します。
追加機能の実装は、基本機能の安定動作を確認後に行います。

## 5. FIWARE連携の技術詳細

### NGSIv2データモデル
```json
{
  "id": "urn:ngsi-ld:TemperatureSensor:001",
  "type": "TemperatureSensor",
  "temperature": {
    "type": "Number",
    "value": 25.4,
    "metadata": {
      "timestamp": {
        "type": "DateTime",
        "value": "2024-04-08T10:00:00.000Z"
      }
    }
  },
  "status": {
    "type": "Text",
    "value": "active"
  }
}
```

### 基本的なデータフロー
1. センサーシミュレーション
   - 温度値の生成
   - タイムスタンプの付与

2. FIWARE連携
   - エンティティの作成/更新
   - 定期的なデータ送信
   - エラー時の再試行

3. 状態管理
   - センサー状態の監視
   - 接続状態の確認

## 5. マルチインスタンス実装の技術的詳細

### データモデル
```json
{
  "instanceId": "sensor-001",
  "type": "temperature",
  "template": "room-sensor",
  "config": {
    "name": "Room 101 Temperature",
    "interval": 5000,
    "baseValue": 25,
    "variation": 1.0
  },
  "status": {
    "running": true,
    "lastValue": 25.3,
    "lastUpdate": "2024-04-08T10:00:00Z",
    "errorCount": 0
  },
  "group": "floor-1"
}
```

### フロー構造
1. インスタンス管理フロー
   - インスタンス生成/削除ロジック
   - 設定管理
   - 状態監視

2. テンプレート管理フロー
   - テンプレート定義
   - パラメータ検証
   - デフォルト値管理

3. データ処理フロー
   - インスタンスごとのデータストリーム
   - 集約処理
   - 永続化

### スケーラビリティ考慮事項
1. メモリ使用量の最適化
   - インスタンスごとのリソース制限
   - 不要なデータの適切な破棄

2. パフォーマンス最適化
   - バッチ処理の活用
   - キャッシュ戦略
   - 非同期処理の活用 